FROM ruby:2.6.1

ARG ENVIRONMENT=staging
ENV RAILS_ENV=${ENVIRONMENT}

ENV DEBIAN_FRONTEND noninteractive

RUN apt-get update && \
  apt-get install -y curl && \
  apt-get install -y mysql-server mysql-client unixodbc unixodbc-dev default-libmysqlclient-dev --no-install-recommends && \
  apt-get clean && \
  gem update --system && gem install bundler && \
  rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

RUN mkdir /build
WORKDIR /build


WORKDIR /app
ADD Gemfile /app
ADD Gemfile.lock /app
RUN gem install bundler:2.1.4; bundle install --without=development

RUN mkdir -p ./shared/pids/ && \
    mkdir -p ./shared/log/ && \
    mkdir -p ./shared/sockets/ && \
    chmod -R 666 ./shared/

COPY . /app/
