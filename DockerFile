FROM node:14-alpine
RUN apk --no-cache add git openssh-client python3 make g++
RUN ln -s /usr/bin/python3 /usr/bin/python
RUN mkdir /app
WORKDIR /app

COPY package*.json .npmrc /app/

ARG ENVIRONMENT=staging
ENV STAGE=${ENVIRONMENT}

ARG ENV_ID=master
ENV ENV_ID=${ENV_ID}
ARG GIT_COMMIT=unknown
ENV GIT_COMMIT=${GIT_COMMIT}
ARG SENTRY_TOKEN=unknown
ENV SENTRY_TOKEN=${SENTRY_TOKEN}

# Setup git
ARG GIT_SSH_KEY
RUN mkdir /root/.ssh/
RUN echo "${GIT_SSH_KEY}" > /root/.ssh/id_rsa
RUN chmod 0400 /root/.ssh/id_rsa
RUN touch /root/.ssh/known_hosts
RUN ssh-keyscan github.com >> /root/.ssh/known_hosts

# Setup NPM
ARG GITHUB_NPM_TOKEN
RUN echo "//npm.pkg.github.com/:_authToken=${GITHUB_NPM_TOKEN}" >> .npmrc

# Build
RUN npm i
COPY . /app/
RUN npm run build:release

CMD ["make", "dev-server"]
